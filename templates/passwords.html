{{define "layout"}}
{{if .Passwords}}
{{range .Passwords}}
<div class="password-card" title="{{.Notes}}">
    <div class="card-info">
        <h3>{{.Site}}</h3>
        <p>{{.Username}}</p>
    </div>
    <div class="card-actions">
        <button class="btn btn-secondary" onclick="copyPassword('{{.EncryptedPassword}}', this)">Copy</button>
        <button class="btn btn-secondary"
            onclick="showEditModal('{{.ID}}', '{{.Site}}', '{{.Username}}', '{{.Notes}}')">Edit</button>
        <form hx-post="/passwords/delete" hx-swap="none" style="display:inline;">
            <input type="hidden" name="id" value="{{.ID}}">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </div>
</div>
{{end}}
{{else}}
<div class="empty-state">
    <p>No passwords stored yet. Click "+ Add Password" to get started.</p>
</div>
{{end}}

<script>
    async function copyPassword(encrypted, btn) {
        const originalText = btn.innerText;
        btn.innerText = "Copying...";

        try {
            const resp = await fetch('/passwords/decrypt?p=' + encodeURIComponent(encrypted));
            if (!resp.ok) throw new Error('Decryption failed');
            const password = await resp.text();

            await navigator.clipboard.writeText(password);

            btn.innerText = "Copied!";
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('btn-success');
            }, 2000);
        } catch (err) {
            console.error('Failed to copy: ', err);
            alert("Failed to copy password to clipboard.");
            btn.innerText = originalText;
        }
    }
</script>
{{end}}