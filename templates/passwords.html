{{define "layout"}}
{{if .Passwords}}
{{range .Passwords}}
<div class="password-card" title="{{.Notes}}">
    <div class="card-info">
        <h3>{{.Site}}</h3>
        <p>{{.Username}}</p>
        <div class="password-field">
            <span id="pwd-val-{{.ID}}" style="display:none; margin-right: 10px; font-family: monospace;"></span>
            <span id="pwd-mask-{{.ID}}">••••••••</span>
        </div>
    </div>
    <div class="card-actions">
        <button class="btn btn-secondary" aria-label="{{printf (T "ShowPasswordFor") .Site}}" onclick="togglePassword('{{.EncryptedPassword}}', '{{.ID}}', this)">{{T "Show"}}</button>
        <button class="btn btn-secondary" aria-label="{{printf (T "CopyPasswordFor") .Site}}" onclick="copyPassword('{{.EncryptedPassword}}', this)">{{T "Copy"}}</button>
        <button class="btn btn-secondary" aria-label="{{printf (T "EditPasswordFor") .Site}}"
            onclick="showEditModal('{{.ID}}', '{{.Site}}', '{{.Username}}', '{{.Notes}}')">{{T "Edit"}}</button>
        <form hx-post="/passwords/delete" hx-swap="none" hx-confirm="{{T "ConfirmDelete"}}" style="display:inline;">
            {{ $.csrfField }}
            <input type="hidden" name="id" value="{{.ID}}">
            <button type="submit" class="btn btn-danger" aria-label="{{printf (T "DeletePasswordFor") .Site}}">{{T "Delete"}}</button>
        </form>
    </div>
</div>
{{end}}
{{else}}
<div class="empty-state">
    <p>{{T "NoPasswordsYet"}}</p>
</div>
{{end}}

<script>
    async function copyPassword(encrypted, btn) {
        const originalText = btn.innerText;
        btn.innerText = '{{T "Copying"}}';

        try {
            const resp = await fetch('/passwords/decrypt?p=' + encodeURIComponent(encrypted));
            if (!resp.ok) throw new Error('{{T "DecryptionFailed"}}');
            const password = await resp.text();

            await navigator.clipboard.writeText(password);

            btn.innerText = '{{T "Copied"}}';
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('btn-success');
            }, 2000);
        } catch (err) {
            console.error('Failed to copy: ', err);
            alert('{{T "DecryptionError"}}');
            btn.innerText = originalText;
        }
    }

    async function togglePassword(encrypted, id, btn) {
        const valSpan = document.getElementById('pwd-val-' + id);
        const maskSpan = document.getElementById('pwd-mask-' + id);

        if (valSpan.style.display === 'none') {
            // Show
            if (!valSpan.innerText) {
                // Fetch if empty
                try {
                    const resp = await fetch('/passwords/decrypt?p=' + encodeURIComponent(encrypted));
                    if (!resp.ok) throw new Error('{{T "DecryptionFailed"}}');
                    valSpan.innerText = await resp.text();
                } catch (err) {
                    console.error('Failed to decrypt: ', err);
                    alert('{{T "DecryptionFailed"}}');
                    return;
                }
            }
            valSpan.style.display = 'inline';
            maskSpan.style.display = 'none';
            btn.innerText = '{{T "Hide"}}';
        } else {
            // Hide
            valSpan.style.display = 'none';
            maskSpan.style.display = 'inline';
            btn.innerText = '{{T "Show"}}';
        }
    }
</script>
{{end}}