{{define "layout"}}
{{if .Passwords}}
{{range .Passwords}}
<div class="password-card" title="{{.Notes}}">
    <div class="card-info">
        <h3>{{.Site}}</h3>
        <p>{{.Username}}</p>
        <div class="password-field">
            <span id="pwd-val-{{.ID}}" style="display:none; margin-right: 10px; font-family: monospace;"></span>
            <span id="pwd-mask-{{.ID}}">••••••••</span>
        </div>
    </div>
    <div class="card-actions">
        <button class="btn btn-secondary"
            aria-label='{{printf (T "ShowPasswordFor") .Site}}'
            aria-controls="pwd-val-{{.ID}}"
            aria-expanded="false"
            data-label-show='{{printf (T "ShowPasswordFor") .Site}}'
            data-label-hide='{{printf (T "HidePasswordFor") .Site}}'
            onclick="togglePassword('{{.EncryptedPassword}}', '{{.ID}}', this)">{{T "Show"}}</button>
        <button class="btn btn-secondary" aria-label='{{printf (T "CopyPasswordFor") .Site}}'
            onclick="copyPassword('{{.EncryptedPassword}}', this)">{{T "Copy"}}</button>
        <button class="btn btn-secondary" aria-label='{{printf (T "EditPasswordFor") .Site}}'
            onclick="showEditModal('{{.ID}}', '{{.Site}}', '{{.Username}}', '{{.Notes}}')">{{T "Edit"}}</button>

        <button class="btn btn-danger" aria-label='{{printf (T "DeletePasswordFor") .Site}}'
            onclick="confirmDeletePassword('{{.ID}}', '{{.Site}}')">{{T "Delete"}}</button>
    </div>
</div>
{{end}}
{{else}}
<div class="empty-state">
    <p>{{T "NoPasswordsYet"}}</p>
    <button class="btn btn-primary" onclick="showAddModal()" style="margin-top: 1rem;">
        {{T "AddPassword"}}
    </button>
</div>
{{end}}

<script>
    async function copyPassword(encrypted, btn) {
        const originalText = btn.innerText;
        btn.innerText = '{{T "Copying"}}';

        try {
            const resp = await fetch('/passwords/decrypt?p=' + encodeURIComponent(encrypted));
            if (!resp.ok) throw new Error('{{T "DecryptionFailed"}}');
            const password = await resp.text();

            await navigator.clipboard.writeText(password);

            btn.innerText = '{{T "Copied"}}';
            btn.classList.add('btn-success');
            setTimeout(() => {
                btn.innerText = originalText;
                btn.classList.remove('btn-success');
            }, 2000);
        } catch (err) {
            console.error('Failed to copy: ', err);
            window.showModal({ message: '{{T "DecryptionError"}}' });
            btn.innerText = originalText;
        }
    }

    async function togglePassword(encrypted, id, btn) {
        const valSpan = document.getElementById('pwd-val-' + id);
        const maskSpan = document.getElementById('pwd-mask-' + id);
        const isHidden = valSpan.style.display === 'none';

        if (isHidden) {
            // Show
            if (!valSpan.innerText) {
                // Fetch if empty
                const originalText = btn.innerText;
                try {
                    btn.innerText = '{{T "Loading"}}...';
                    btn.setAttribute('aria-busy', 'true');
                    btn.disabled = true;

                    const resp = await fetch('/passwords/decrypt?p=' + encodeURIComponent(encrypted));
                    if (!resp.ok) throw new Error('{{T "DecryptionFailed"}}');
                    valSpan.innerText = await resp.text();
                } catch (err) {
                    console.error('Failed to decrypt: ', err);
                    window.showModal({ message: '{{T "DecryptionFailed"}}' });
                    btn.innerText = originalText;
                    return;
                } finally {
                    btn.setAttribute('aria-busy', 'false');
                    btn.disabled = false;
                }
            }
            valSpan.style.display = 'inline';
            maskSpan.style.display = 'none';
            btn.innerText = '{{T "Hide"}}';
            btn.setAttribute('aria-expanded', 'true');
            if (btn.dataset.labelHide) btn.setAttribute('aria-label', btn.dataset.labelHide);
        } else {
            // Hide
            valSpan.style.display = 'none';
            maskSpan.style.display = 'inline';
            btn.innerText = '{{T "Show"}}';
            btn.setAttribute('aria-expanded', 'false');
            if (btn.dataset.labelShow) btn.setAttribute('aria-label', btn.dataset.labelShow);
        }
    }

    function confirmDeletePassword(id, site) {
        window.showModal({
            title: `{{T "ConfirmAction"}}`,
            message: `{{T "ConfirmDelete"}}` + ` (` + site + `)`,
            isConfirm: true,
            onConfirm: function () {
                htmx.ajax('POST', '/passwords/delete', {
                    values: { id: id },
                    swap: 'none'
                });
            }
        });
    }
</script>
{{end}}