{{define "content"}}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>{{T "WelcomeToVault"}}</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="showChangePasswordModal()">{{T "ChangePassword"}}</button>
            <button class="btn btn-secondary" onclick="showImportModal()">{{T "ImportCSV"}}</button>
            <a href="/passwords/export" class="btn btn-secondary" target="_blank" rel="noopener noreferrer" aria-label='{{T "ExportCSV"}} - {{T "OpensInNewWindow"}}'>{{T "ExportCSV"}}</a>
            <button class="btn btn-primary" onclick="showAddModal()">{{T "AddPassword"}}</button>
        </div>
    </div>

    <div class="password-grid" hx-get="/passwords" hx-trigger="load, passwordChanged from:body">
        <div class="loading">{{T "LoadingPasswords"}}</div>
    </div>
</div>

<!-- Add Password Modal -->
<div id="add-password-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="add-modal-title">
    <div class="modal-content">
        <h2 id="add-modal-title">{{T "AddNewPassword"}}</h2>
        <form hx-post="/passwords/add" hx-swap="none"
              hx-disabled-elt="find button[type='submit']"
              hx-on::after-request="if(event.detail.successful) hideAddModal();">
            {{ .csrfField }}
            <div class="form-group">
                <label for="add-site">{{T "SiteService"}}</label>
                <input type="text" name="site" id="add-site" required placeholder="{{T " EGGoogle"}}">
            </div>
            <div class="form-group">
                <label for="add-username">{{T "Username"}}</label>
                <input type="text" name="username" id="add-username" required placeholder="{{T " EmailOrUsername"}}">
            </div>
            <div class="form-group">
                <label for="add-password">{{T "Password"}}</label>
                <input type="password" name="password" id="add-password" required placeholder="{{T " SitePassword"}}">
            </div>
            <div class="form-group">
                <label for="add-notes">{{T "Notes"}}</label>
                <textarea name="notes" id="add-notes" placeholder="{{T " OptionalNotes"}}"></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideAddModal()">{{T "Cancel"}}</button>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-default-text">{{T "SavePassword"}}</span>
                    <span class="btn-loading-indicator">{{T "Saving"}}</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Password Modal -->
<div id="edit-password-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title">
    <div class="modal-content">
        <h2 id="edit-modal-title">{{T "EditPassword"}}</h2>
        <form hx-post="/passwords/update" hx-swap="none"
              hx-disabled-elt="find button[type='submit']"
              hx-on::after-request="if(event.detail.successful) hideEditModal();">
            {{ .csrfField }}
            <input type="hidden" name="id" id="edit-id">
            <div class="form-group">
                <label for="edit-site">{{T "SiteService"}}</label>
                <input type="text" name="site" id="edit-site" required>
            </div>
            <div class="form-group">
                <label for="edit-username">{{T "Username"}}</label>
                <input type="text" name="username" id="edit-username" required>
            </div>
            <div class="form-group">
                <label for="edit-password">{{T "Password"}}</label>
                <input type="password" name="password" id="edit-password" required placeholder="{{T " SitePassword"}}">
            </div>
            <div class="form-group">
                <label for="edit-notes">{{T "Notes"}}</label>
                <textarea name="notes" id="edit-notes" placeholder="{{T " OptionalNotes"}}"></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideEditModal()">{{T "Cancel"}}</button>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-default-text">{{T "UpdatePassword"}}</span>
                    <span class="btn-loading-indicator">{{T "Updating"}}</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Change Password Modal -->
<div id="change-password-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="change-pwd-title">
    <div class="modal-content">
        <h2 id="change-pwd-title">{{T "ChangeAccountPassword"}}</h2>
        <form hx-post="/change-password" hx-swap="none"
              hx-disabled-elt="find button[type='submit']"
              hx-on::after-request="if(event.detail.successful) hideChangePasswordModal();">
            {{ .csrfField }}
            <div class="form-group">
                <label for="change-new-password">{{T "NewPassword"}}</label>
                <input type="password" name="new_password" id="change-new-password" required placeholder="{{T " EnterPassword"}}">
            </div>
            <div id="password-error" class="error"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideChangePasswordModal()">{{T
                    "Cancel"}}</button>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-default-text">{{T "UpdatePassword"}}</span>
                    <span class="btn-loading-indicator">{{T "Updating"}}</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Import Passwords Modal -->
<div id="import-password-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="import-modal-title">
    <div class="modal-content">
        <h2 id="import-modal-title">{{T "ImportChromePasswords"}}</h2>
        <p style="margin-bottom: 1.5rem; color: var(--text-muted);">{{T "ImportInstructions"}}</p>
        <form hx-post="/passwords/import" hx-encoding="multipart/form-data" hx-swap="none"
              hx-disabled-elt="find button[type='submit']"
              hx-on::after-request="if(event.detail.successful) { hideImportModal(); htmx.trigger('body', 'passwordChanged'); }">
            {{ .csrfField }}
            <div class="form-group">
                <label for="import-csv-file" class="sr-only" style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;">{{T "ImportCSV"}}</label>
                <input type="file" name="csv_file" id="import-csv-file" accept=".csv" required>
            </div>
            <div id="import-error" class="error"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideImportModal()">{{T "Cancel"}}</button>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-default-text">{{T "ImportNow"}}</span>
                    <span class="btn-loading-indicator">{{T "Importing"}}</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let lastFocusedElement;

    function openModalHelper(id) {
        lastFocusedElement = document.activeElement;
        const modal = document.getElementById(id);
        modal.style.display = 'flex';
        // Focus first input
        const firstInput = modal.querySelector('input, textarea, select, button');
        if (firstInput) setTimeout(() => firstInput.focus(), 50);
    }

    function closeModalHelper(id) {
        document.getElementById(id).style.display = 'none';
        if (lastFocusedElement) lastFocusedElement.focus();
    }

    // Global Escape key handler
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (document.getElementById('add-password-modal').style.display === 'flex') hideAddModal();
            else if (document.getElementById('edit-password-modal').style.display === 'flex') hideEditModal();
            else if (document.getElementById('change-password-modal').style.display === 'flex') hideChangePasswordModal();
            else if (document.getElementById('import-password-modal').style.display === 'flex') hideImportModal();
        }
    });

    function showImportModal() {
        openModalHelper('import-password-modal');
    }
    function hideImportModal() {
        closeModalHelper('import-password-modal');
        document.getElementById('import-error').innerText = '';
    }
    function showAddModal() {
        openModalHelper('add-password-modal');
    }
    function hideAddModal() {
        closeModalHelper('add-password-modal');
    }
    function showEditModal(id, site, username, notes) {
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-site').value = site;
        document.getElementById('edit-username').value = username;
        document.getElementById('edit-notes').value = notes;
        openModalHelper('edit-password-modal');
    }
    function hideEditModal() {
        closeModalHelper('edit-password-modal');
    }
    function showChangePasswordModal() {
        openModalHelper('change-password-modal');
    }
    function hideChangePasswordModal() {
        closeModalHelper('change-password-modal');
    }

    document.body.addEventListener('passwordUpdated', function () {
        window.showModal({ message: '{{T "PasswordUpdatedSuccessfully"}}' });
    });
</script>
{{end}}