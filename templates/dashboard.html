{{define "content"}}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>{{T "WelcomeToVault"}}</h1>
        <div class="header-actions">
            <div class="search-wrapper">
                <input type="text" class="search-input" id="password-search" placeholder="{{T "SearchPasswords"}}"
                    oninput="filterPasswords(this.value)">
                <kbd class="search-shortcut">/</kbd>
            </div>
            <button class="btn btn-secondary" onclick="showChangePasswordModal()">{{T "ChangePassword"}}</button>
            <button class="btn btn-secondary" onclick="showImportModal()">{{T "ImportCSV"}}</button>
            <a href="/passwords/export" class="btn btn-secondary" target="_blank" rel="noopener noreferrer"
                aria-label='{{T "ExportCSV"}} - {{T "OpensInNewWindow"}}'>{{T "ExportCSV"}}</a>
            <button class="btn btn-primary" onclick="showAddModal()">{{T "AddPassword"}}</button>
        </div>
    </div>

    <div class="password-grid" id="password-grid" hx-get="/passwords" hx-trigger="load, passwordChanged from:body">
        <!-- Skeleton Loading -->
        <div class="skeleton-card">
            <div class="card-info">
                <div class="skeleton skeleton-title"></div>
                <div class="skeleton skeleton-text"></div>
            </div>
            <div class="card-actions">
                <div class="skeleton skeleton-btn"></div>
                <div class="skeleton skeleton-btn"></div>
            </div>
        </div>
        <div class="skeleton-card">
            <div class="card-info">
                <div class="skeleton skeleton-title"></div>
                <div class="skeleton skeleton-text"></div>
            </div>
            <div class="card-actions">
                <div class="skeleton skeleton-btn"></div>
                <div class="skeleton skeleton-btn"></div>
            </div>
        </div>
        <div class="skeleton-card">
            <div class="card-info">
                <div class="skeleton skeleton-title"></div>
                <div class="skeleton skeleton-text"></div>
            </div>
            <div class="card-actions">
                <div class="skeleton skeleton-btn"></div>
                <div class="skeleton skeleton-btn"></div>
            </div>
        </div>
    </div>

    <div id="search-empty-state" class="empty-state" style="display: none;">
        <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <h3>{{T "NoSearchResults"}}</h3>
        <button class="btn btn-secondary" onclick="clearSearch()">{{T "ClearSearch"}}</button>
    </div>
</div>

<!-- Add Password Modal -->
<div id="add-password-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="add-modal-title">
    <div class="modal-content">
        <h2 id="add-modal-title">{{T "AddNewPassword"}}</h2>
        <form hx-post="/passwords/add" hx-swap="none" hx-disabled-elt="find button[type='submit']"
            hx-on::after-request="if(event.detail.successful) hideAddModal();">
            {{ .csrfField }}
            <div class="form-group">
                <label for="add-site">{{T "SiteService"}}</label>
                <input type="text" name="site" id="add-site" required placeholder="{{T " EGGoogle"}}">
            </div>
            <div class="form-group">
                <label for="add-username">{{T "Username"}}</label>
                <input type="text" name="username" id="add-username" required placeholder="{{T " EmailOrUsername"}}">
            </div>
            <div class="form-group">
                <label for="add-password">{{T "Password"}}</label>
                <div class="password-generator">
                    <input type="password" name="password" id="add-password" required placeholder="{{T "SitePassword"}}">
                    <button type="button" class="btn-generate" onclick="generateAndFillPassword('add-password')"
                        aria-label="{{T "GeneratePassword"}}" title="{{T "GeneratePassword"}}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label for="add-notes">{{T "Notes"}}</label>
                <textarea name="notes" id="add-notes" placeholder="{{T " OptionalNotes"}}"></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideAddModal()">{{T "Cancel"}}</button>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-default-text">{{T "SavePassword"}}</span>
                    <span class="btn-loading-indicator">{{T "Saving"}}</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Password Modal -->
<div id="edit-password-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title">
    <div class="modal-content">
        <h2 id="edit-modal-title">{{T "EditPassword"}}</h2>
        <form hx-post="/passwords/update" hx-swap="none" hx-disabled-elt="find button[type='submit']"
            hx-on::after-request="if(event.detail.successful) hideEditModal();">
            {{ .csrfField }}
            <input type="hidden" name="id" id="edit-id">
            <div class="form-group">
                <label for="edit-site">{{T "SiteService"}}</label>
                <input type="text" name="site" id="edit-site" required>
            </div>
            <div class="form-group">
                <label for="edit-username">{{T "Username"}}</label>
                <input type="text" name="username" id="edit-username" required>
            </div>
            <div class="form-group">
                <label for="edit-password">{{T "Password"}}</label>
                <div class="password-generator">
                    <input type="password" name="password" id="edit-password" required placeholder="{{T "SitePassword"}}">
                    <button type="button" class="btn-generate" onclick="generateAndFillPassword('edit-password')"
                        aria-label="{{T "GeneratePassword"}}" title="{{T "GeneratePassword"}}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label for="edit-notes">{{T "Notes"}}</label>
                <textarea name="notes" id="edit-notes" placeholder="{{T " OptionalNotes"}}"></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideEditModal()">{{T "Cancel"}}</button>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-default-text">{{T "UpdatePassword"}}</span>
                    <span class="btn-loading-indicator">{{T "Updating"}}</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Change Password Modal -->
<div id="change-password-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="change-pwd-title">
    <div class="modal-content">
        <h2 id="change-pwd-title">{{T "ChangeAccountPassword"}}</h2>
        <form hx-post="/change-password" hx-swap="none" hx-disabled-elt="find button[type='submit']"
            hx-on::after-request="if(event.detail.successful) hideChangePasswordModal();">
            {{ .csrfField }}
            <div class="form-group">
                <label for="change-current-password">{{T "CurrentPassword"}}</label>
                <input type="password" name="current_password" id="change-current-password" required placeholder="{{T "EnterPassword"}}">
            </div>
            <div class="form-group">
                <label for="change-new-password">{{T "NewPassword"}}</label>
                <input type="password" name="new_password" id="change-new-password" required placeholder="{{T "EnterPassword"}}">
            </div>
            <div id="password-error" class="error"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideChangePasswordModal()">{{T
                    "Cancel"}}</button>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-default-text">{{T "UpdatePassword"}}</span>
                    <span class="btn-loading-indicator">{{T "Updating"}}</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Import Passwords Modal -->
<div id="import-password-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="import-modal-title">
    <div class="modal-content">
        <h2 id="import-modal-title">{{T "ImportChromePasswords"}}</h2>
        <p style="margin-bottom: 1.5rem; color: var(--text-muted);">{{T "ImportInstructions"}}</p>
        <form hx-post="/passwords/import" hx-encoding="multipart/form-data" hx-swap="none"
            hx-disabled-elt="find button[type='submit']"
            hx-on::after-request="if(event.detail.successful) { hideImportModal(); htmx.trigger('body', 'passwordChanged'); }">
            {{ .csrfField }}
            <div class="form-group">
                <label for="import-csv-file" class="sr-only"
                    style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;">{{T "ImportCSV"}}</label>
                <input type="file" name="csv_file" id="import-csv-file" accept=".csv" required>
            </div>
            <div id="import-error" class="error"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="hideImportModal()">{{T "Cancel"}}</button>
                <button type="submit" class="btn btn-primary">
                    <span class="btn-default-text">{{T "ImportNow"}}</span>
                    <span class="btn-loading-indicator">{{T "Importing"}}</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    let lastFocusedElement;

    function openModalHelper(id) {
        lastFocusedElement = document.activeElement;
        const modal = document.getElementById(id);
        modal.style.display = 'flex';
        // Focus first input
        const firstInput = modal.querySelector('input, textarea, select, button');
        if (firstInput) setTimeout(() => firstInput.focus(), 50);
    }

    function closeModalHelper(id) {
        document.getElementById(id).style.display = 'none';
        if (lastFocusedElement) lastFocusedElement.focus();
    }

    // Global Escape key handler
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            if (document.getElementById('add-password-modal').style.display === 'flex') hideAddModal();
            else if (document.getElementById('edit-password-modal').style.display === 'flex') hideEditModal();
            else if (document.getElementById('change-password-modal').style.display === 'flex') hideChangePasswordModal();
            else if (document.getElementById('import-password-modal').style.display === 'flex') hideImportModal();
        }
    });

    function showImportModal() {
        openModalHelper('import-password-modal');
    }
    function hideImportModal() {
        closeModalHelper('import-password-modal');
        document.getElementById('import-error').innerText = '';
    }
    function showAddModal() {
        openModalHelper('add-password-modal');
    }
    function hideAddModal() {
        closeModalHelper('add-password-modal');
    }
    function showEditModal(id, site, username, notes) {
        document.getElementById('edit-id').value = id;
        document.getElementById('edit-site').value = site;
        document.getElementById('edit-username').value = username;
        document.getElementById('edit-notes').value = notes;
        openModalHelper('edit-password-modal');
    }
    function hideEditModal() {
        closeModalHelper('edit-password-modal');
    }
    function showChangePasswordModal() {
        openModalHelper('change-password-modal');
    }
    function hideChangePasswordModal() {
        closeModalHelper('change-password-modal');
    }

    document.body.addEventListener('passwordUpdated', function () {
        window.showModal({ message: '{{T "PasswordUpdatedSuccessfully"}}' });
    });

    // Search/Filter passwords
    function filterPasswords(query) {
        const cards = document.querySelectorAll('#password-grid .password-card');
        const lowerQuery = query.toLowerCase();
        let hasVisible = false;

        cards.forEach(card => {
            const site = card.querySelector('h3')?.textContent.toLowerCase() || '';
            const username = card.querySelector('.card-info p')?.textContent.toLowerCase() || '';

            if (site.includes(lowerQuery) || username.includes(lowerQuery)) {
                card.style.display = '';
                hasVisible = true;
            } else {
                card.style.display = 'none';
            }
        });

        // Show/hide empty state for search
        const emptyState = document.getElementById('search-empty-state');
        if (cards.length > 0) {
            if (!hasVisible && query.length > 0) {
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
            }
        }
    }

    function clearSearch() {
        const input = document.getElementById('password-search');
        input.value = '';
        filterPasswords('');
        input.focus();
    }

    // Password Generator
    function generatePassword(length = 16) {
        const uppercase = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const lowercase = 'abcdefghijklmnopqrstuvwxyz';
        const numbers = '0123456789';
        const symbols = '!@#$%^&*()_+-=[]{}|;:,.<>?';
        const allChars = uppercase + lowercase + numbers + symbols;

        let password = '';
        // Ensure at least one of each type
        password += uppercase[Math.floor(Math.random() * uppercase.length)];
        password += lowercase[Math.floor(Math.random() * lowercase.length)];
        password += numbers[Math.floor(Math.random() * numbers.length)];
        password += symbols[Math.floor(Math.random() * symbols.length)];

        // Fill the rest
        for (let i = password.length; i < length; i++) {
            password += allChars[Math.floor(Math.random() * allChars.length)];
        }

        // Shuffle
        return password.split('').sort(() => Math.random() - 0.5).join('');
    }

    function generateAndFillPassword(inputId) {
        const input = document.getElementById(inputId);
        input.value = generatePassword(16);
        input.type = 'text'; // Show the generated password
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ignore if user is typing in an input, textarea, or contenteditable
        if (['INPUT', 'TEXTAREA'].includes(e.target.tagName) || e.target.isContentEditable) {
            return;
        }

        if (e.key === '/' || ((e.ctrlKey || e.metaKey) && e.key === 'k')) {
            e.preventDefault();
            const searchInput = document.getElementById('password-search');
            if (searchInput) {
                searchInput.focus();
            }
        }
    });
</script>
{{end}}