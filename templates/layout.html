{{define "layout"}}
<!DOCTYPE html>
<html lang="{{.Lang}}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.AppName}} - {{T "PasswordManager"}}</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <meta name="csrf-token" content="{{.csrfToken}}">
    <style>
        .password-input-wrapper {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
        }

        .password-toggle:hover {
            background: transparent;
            color: var(--primary);
        }
    </style>
</head>

<body class="dark-mode">
    <nav>
        <div class="container">
            <a href="/" class="logo">{{.AppName}}</a>
            <div class="nav-links">
                {{if .}}
                <a href="/dashboard">{{T "Dashboard"}}</a>
                {{if .IsAdmin}}
                <a href="/admin">{{T "Admin"}}</a>
                {{end}}
                <a href="/logout">{{T "Logout"}}</a>
                {{else}}
                <a href="/login">{{T "Login"}}</a>
                <a href="/signup">{{T "Signup"}}</a>
                {{end}}
            </div>
        </div>
    </nav>

    <main class="container">
        {{template "content" .}}
    </main>

    <div id="toast-container"></div>

    <!-- Reusable Modal (Alert/Confirm) -->
    <div id="reusableModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle" style="text-align: center; margin-bottom: 1rem;">{{T "Notification"}}</h2>
            <p id="modalMessage" style="text-align: center; margin-bottom: 2rem; color: var(--text-muted);"></p>
            <div class="modal-actions" style="justify-content: center;">
                <button id="modalPrimaryBtn" class="btn btn-primary">{{T "Yes"}}</button>
                <button id="modalSecondaryBtn" class="btn btn-secondary">{{T "Cancel"}}</button>
            </div>
        </div>
    </div>

    <script>
        // CSRF handling for all HTMX requests
        document.body.addEventListener('htmx:configRequest', (event) => {
            const token = document.querySelector('meta[name="csrf-token"]').content;
            if (token) {
                event.detail.headers['X-CSRF-Token'] = token;
            }
        });

        // Global Modal Logic
        window.showModal = function (options) {
            const modal = document.getElementById('reusableModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            const primaryBtn = document.getElementById('modalPrimaryBtn');
            const secondaryBtn = document.getElementById('modalSecondaryBtn');

            // 1. Save currently focused element to restore later
            const previousFocus = document.activeElement;

            title.textContent = options.title || `{{T "Notification"}}`;
            message.textContent = options.message || '';

            if (options.isConfirm) {
                secondaryBtn.style.display = 'block';
                secondaryBtn.textContent = options.secondaryText || `{{T "Cancel"}}`;
                primaryBtn.textContent = options.primaryText || `{{T "Yes"}}`;
            } else {
                secondaryBtn.style.display = 'none';
                primaryBtn.textContent = options.primaryText || `{{T "OK"}}`;
            }

            modal.style.display = 'flex';

            // 2. Focus the primary button (or appropriate action)
            // Using setTimeout to ensure rendering is complete
            setTimeout(() => {
                if (options.isConfirm) {
                    // For destructive actions, maybe focus cancel?
                    // But standard pattern often focuses primary. Let's stick to primary for now.
                    primaryBtn.focus();
                } else {
                    primaryBtn.focus();
                }
            }, 50);

            const cleanup = () => {
                modal.style.display = 'none';
                primaryBtn.onclick = null;
                secondaryBtn.onclick = null;
                document.removeEventListener('keydown', handleEscape);

                // 4. Restore focus
                if (previousFocus) previousFocus.focus();
            };

            // 3. Handle Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    cleanup();
                    if (options.onCancel) options.onCancel();
                }
            };
            document.addEventListener('keydown', handleEscape);

            primaryBtn.onclick = () => {
                cleanup();
                if (options.onConfirm) options.onConfirm();
            };

            secondaryBtn.onclick = () => {
                cleanup();
                if (options.onCancel) options.onCancel();
            };
        };

        // Handle HTMX response errors
        document.body.addEventListener('htmx:responseError', function (evt) {
            console.error("HTMX Response Error:", evt.detail);
            window.showModal({
                title: 'Error',
                message: 'Server error: ' + evt.detail.xhr.status + ' ' + (evt.detail.xhr.statusText || 'Unknown Error')
            });
        });

        // Handle HTMX send errors (network)
        document.body.addEventListener('htmx:sendError', function (evt) {
            console.error("HTMX Send Error:", evt.detail);
            window.showModal({
                title: 'Error',
                message: 'Network error. Please check your connection.'
            });
        });

        // Toggle Password Visibility
        function toggleInputPassword(btn, inputId) {
            const input = document.getElementById(inputId);
            const isPassword = input.type === 'password';
            input.type = isPassword ? 'text' : 'password';
            btn.innerText = isPassword ? '{{T "Hide"}}' : '{{T "Show"}}';
            btn.setAttribute('aria-label', isPassword ? '{{T "HidePassword"}}' : '{{T "ShowPassword"}}');
        }
    </script>
</body>

</html>
{{end}}